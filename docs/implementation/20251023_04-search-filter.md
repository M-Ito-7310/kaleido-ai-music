# Phase 4: æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ - è©³ç´°å®Ÿè£…ã‚¬ã‚¤ãƒ‰

**Phase**: 4/7
**æ¨å®šæ™‚é–“**: 1-2æ—¥
**å‰ææ¡ä»¶**: Phase 1-3å®Œäº†
**æ¬¡ã®Phase**: Phase 5 - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

---

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å®Ÿè£…](#ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å®Ÿè£…)
3. [ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å®Ÿè£…](#ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å®Ÿè£…)
4. [æ¤œç´¢æ©Ÿèƒ½å®Ÿè£…](#æ¤œç´¢æ©Ÿèƒ½å®Ÿè£…)
5. [ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½å®Ÿè£…](#ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½å®Ÿè£…)
6. [URLåŒæœŸã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³](#urlåŒæœŸã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³)
7. [ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ç®¡ç†](#ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ç®¡ç†)
8. [å‹•ä½œç¢ºèª](#å‹•ä½œç¢ºèª)
9. [æˆæœç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#æˆæœç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## æ¦‚è¦

Phase 4ã§ã¯ã€éŸ³æ¥½ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚«ãƒ†ã‚´ãƒªã€ã‚¿ã‚°ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§éŸ³æ¥½ã‚’çµã‚Šè¾¼ã¿ã€æ–°ç€é †ãƒ»äººæ°—é †ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°é †ã§ä¸¦ã³æ›¿ãˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### ã“ã®Phaseã§å®Ÿç¾ã™ã‚‹ã“ã¨

- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãƒãƒ¼
- ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆæ–°ç€é †ã€äººæ°—é †ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°é †ï¼‰
- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã®URLåŒæœŸ
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

---

## ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å®Ÿè£…

### ã‚¹ãƒ†ãƒƒãƒ— 1: ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `components/filters/CategoryFilter.tsx`

```typescript
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import type { Category } from '@/lib/db/schema';
import { cn } from '@/lib/utils';

interface CategoryFilterProps {
  categories: Category[];
  currentCategory?: string;
}

export function CategoryFilter({ categories, currentCategory }: CategoryFilterProps) {
  const router = useRouter();
  const searchParams = useSearchParams();

  const handleCategoryChange = (categorySlug: string | null) => {
    const params = new URLSearchParams(searchParams.toString());

    if (categorySlug) {
      params.set('category', categorySlug);
    } else {
      params.delete('category');
    }

    // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    params.delete('offset');

    router.push(`/library?${params.toString()}`);
  };

  return (
    <div className="flex flex-col gap-2">
      <h3 className="text-sm font-semibold text-gray-900">ã‚«ãƒ†ã‚´ãƒª</h3>
      <div className="flex flex-wrap gap-2">
        {/* ã™ã¹ã¦ */}
        <button
          onClick={() => handleCategoryChange(null)}
          className={cn(
            'rounded-full px-4 py-2 text-sm font-medium transition-colors',
            !currentCategory
              ? 'bg-primary-600 text-white'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          )}
        >
          ã™ã¹ã¦
        </button>

        {/* å„ã‚«ãƒ†ã‚´ãƒª */}
        {categories.map((category) => (
          <button
            key={category.id}
            onClick={() => handleCategoryChange(category.slug)}
            className={cn(
              'rounded-full px-4 py-2 text-sm font-medium transition-colors',
              currentCategory === category.slug
                ? 'bg-primary-600 text-white'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            )}
          >
            {category.icon && <span className="mr-1">{category.icon}</span>}
            {category.name}
            {category.musicCount > 0 && (
              <span className="ml-1.5 text-xs opacity-75">({category.musicCount})</span>
            )}
          </button>
        ))}
      </div>
    </div>
  );
}
```

### ã‚¹ãƒ†ãƒƒãƒ— 2: ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒ¼ãƒ‰

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `scripts/seed-categories.ts`

```typescript
import { db } from '@/lib/db';
import { categories } from '@/lib/db/schema';

const categoryData = [
  {
    name: 'ãƒãƒƒãƒ—',
    slug: 'pop',
    description: 'æ˜ã‚‹ãè¦ªã—ã¿ã‚„ã™ã„ãƒãƒƒãƒ—ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯',
    icon: 'ğŸµ',
    color: 'blue',
  },
  {
    name: 'ãƒ­ãƒƒã‚¯',
    slug: 'rock',
    description: 'ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ãªãƒ­ãƒƒã‚¯ã‚µã‚¦ãƒ³ãƒ‰',
    icon: 'ğŸ¸',
    color: 'red',
  },
  {
    name: 'ã‚¯ãƒ©ã‚·ãƒƒã‚¯',
    slug: 'classical',
    description: 'å„ªé›…ãªã‚¯ãƒ©ã‚·ãƒƒã‚¯éŸ³æ¥½',
    icon: 'ğŸ»',
    color: 'purple',
  },
  {
    name: 'ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆ',
    slug: 'ambient',
    description: 'è½ã¡ç€ã„ãŸé›°å›²æ°—ã®ç’°å¢ƒéŸ³æ¥½',
    icon: 'ğŸŒŒ',
    color: 'indigo',
  },
  {
    name: 'ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ‹ãƒƒã‚¯',
    slug: 'electronic',
    description: 'ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ã‚’ä½¿ã£ãŸé›»å­éŸ³æ¥½',
    icon: 'ğŸ¹',
    color: 'cyan',
  },
  {
    name: 'ã‚¸ãƒ£ã‚º',
    slug: 'jazz',
    description: 'å³èˆˆæ€§è±Šã‹ãªã‚¸ãƒ£ã‚ºãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯',
    icon: 'ğŸ·',
    color: 'amber',
  },
  {
    name: 'Lo-Fi',
    slug: 'lofi',
    description: 'ãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã‚‹Lo-Fiãƒ’ãƒƒãƒ—ãƒ›ãƒƒãƒ—',
    icon: 'â˜•',
    color: 'orange',
  },
  {
    name: 'ã‚·ãƒãƒãƒ†ã‚£ãƒƒã‚¯',
    slug: 'cinematic',
    description: 'æ˜ ç”»ã®ã‚ˆã†ãªå£®å¤§ãªã‚µã‚¦ãƒ³ãƒ‰ãƒˆãƒ©ãƒƒã‚¯',
    icon: 'ğŸ¬',
    color: 'gray',
  },
];

async function seedCategories() {
  console.log('ğŸŒ± Seeding categories...');

  for (const category of categoryData) {
    await db.insert(categories).values(category).onConflictDoNothing();
    console.log(`âœ… Created category: ${category.name}`);
  }

  console.log('âœ… Categories seeded successfully');
}

seedCategories()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error('âŒ Error seeding categories:', error);
    process.exit(1);
  });
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰:**
```bash
npx tsx scripts/seed-categories.ts
```

---

## ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å®Ÿè£…

### ã‚¹ãƒ†ãƒƒãƒ— 3: ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `components/filters/TagFilter.tsx`

```typescript
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { X } from 'lucide-react';
import type { Tag } from '@/lib/db/schema';
import { cn } from '@/lib/utils';

interface TagFilterProps {
  tags: Tag[];
  selectedTags: string[];
}

export function TagFilter({ tags, selectedTags }: TagFilterProps) {
  const router = useRouter();
  const searchParams = useSearchParams();

  const handleTagToggle = (tagSlug: string) => {
    const params = new URLSearchParams(searchParams.toString());
    const currentTags = params.get('tags')?.split(',').filter(Boolean) || [];

    let newTags: string[];
    if (currentTags.includes(tagSlug)) {
      // ã‚¿ã‚°ã‚’å‰Šé™¤
      newTags = currentTags.filter((t) => t !== tagSlug);
    } else {
      // ã‚¿ã‚°ã‚’è¿½åŠ 
      newTags = [...currentTags, tagSlug];
    }

    if (newTags.length > 0) {
      params.set('tags', newTags.join(','));
    } else {
      params.delete('tags');
    }

    // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    params.delete('offset');

    router.push(`/library?${params.toString()}`);
  };

  const handleClearTags = () => {
    const params = new URLSearchParams(searchParams.toString());
    params.delete('tags');
    params.delete('offset');
    router.push(`/library?${params.toString()}`);
  };

  return (
    <div className="flex flex-col gap-2">
      <div className="flex items-center justify-between">
        <h3 className="text-sm font-semibold text-gray-900">ã‚¿ã‚°</h3>
        {selectedTags.length > 0 && (
          <button
            onClick={handleClearTags}
            className="text-xs text-primary-600 hover:text-primary-700"
          >
            ã‚¯ãƒªã‚¢
          </button>
        )}
      </div>

      {/* é¸æŠä¸­ã®ã‚¿ã‚° */}
      {selectedTags.length > 0 && (
        <div className="flex flex-wrap gap-2 pb-2 border-b border-gray-200">
          {selectedTags.map((tagSlug) => {
            const tag = tags.find((t) => t.slug === tagSlug);
            if (!tag) return null;

            return (
              <button
                key={tag.slug}
                onClick={() => handleTagToggle(tag.slug)}
                className="inline-flex items-center gap-1 rounded-full bg-primary-100 px-3 py-1 text-sm font-medium text-primary-800 hover:bg-primary-200 transition-colors"
              >
                #{tag.name}
                <X className="h-3 w-3" />
              </button>
            );
          })}
        </div>
      )}

      {/* ã™ã¹ã¦ã®ã‚¿ã‚° */}
      <div className="flex flex-wrap gap-2">
        {tags.map((tag) => {
          const isSelected = selectedTags.includes(tag.slug);

          return (
            <button
              key={tag.id}
              onClick={() => handleTagToggle(tag.slug)}
              className={cn(
                'rounded-full px-3 py-1 text-sm font-medium transition-colors',
                isSelected
                  ? 'bg-primary-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              )}
            >
              #{tag.name}
              {tag.count > 0 && (
                <span className="ml-1 text-xs opacity-75">({tag.count})</span>
              )}
            </button>
          );
        })}
      </div>
    </div>
  );
}
```

---

## æ¤œç´¢æ©Ÿèƒ½å®Ÿè£…

### ã‚¹ãƒ†ãƒƒãƒ— 4: æ¤œç´¢ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `components/filters/SearchBar.tsx`

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Search, X } from 'lucide-react';
import { useDebouncedCallback } from 'use-debounce';

export function SearchBar() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [searchQuery, setSearchQuery] = useState(searchParams.get('search') || '');

  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãæ¤œç´¢
  const debouncedSearch = useDebouncedCallback((query: string) => {
    const params = new URLSearchParams(searchParams.toString());

    if (query) {
      params.set('search', query);
    } else {
      params.delete('search');
    }

    // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    params.delete('offset');

    router.push(`/library?${params.toString()}`);
  }, 500);

  useEffect(() => {
    debouncedSearch(searchQuery);
  }, [searchQuery, debouncedSearch]);

  const handleClear = () => {
    setSearchQuery('');
  };

  return (
    <div className="relative">
      <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
        <Search className="h-5 w-5 text-gray-400" />
      </div>
      <input
        type="text"
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
        placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã§æ¤œç´¢..."
        className="block w-full rounded-lg border border-gray-300 bg-white py-2 pl-10 pr-10 text-sm placeholder:text-gray-400 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
      />
      {searchQuery && (
        <button
          onClick={handleClear}
          className="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600"
        >
          <X className="h-5 w-5" />
        </button>
      )}
    </div>
  );
}
```

**ä¾å­˜é–¢ä¿‚ã®è¿½åŠ :**
```bash
npm install use-debounce
```

---

## ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½å®Ÿè£…

### ã‚¹ãƒ†ãƒƒãƒ— 5: ã‚½ãƒ¼ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `components/filters/SortSelector.tsx`

```typescript
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { ArrowUpDown } from 'lucide-react';

type SortOption = 'latest' | 'popular' | 'downloads';

const sortOptions: { value: SortOption; label: string }[] = [
  { value: 'latest', label: 'æ–°ç€é †' },
  { value: 'popular', label: 'äººæ°—é †ï¼ˆå†ç”Ÿæ•°ï¼‰' },
  { value: 'downloads', label: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°é †' },
];

export function SortSelector() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const currentSort = (searchParams.get('sortBy') as SortOption) || 'latest';

  const handleSortChange = (sortBy: SortOption) => {
    const params = new URLSearchParams(searchParams.toString());
    params.set('sortBy', sortBy);
    params.delete('offset');
    router.push(`/library?${params.toString()}`);
  };

  return (
    <div className="flex items-center gap-2">
      <ArrowUpDown className="h-4 w-4 text-gray-500" />
      <select
        value={currentSort}
        onChange={(e) => handleSortChange(e.target.value as SortOption)}
        className="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
      >
        {sortOptions.map((option) => (
          <option key={option.value} value={option.value}>
            {option.label}
          </option>
        ))}
      </select>
    </div>
  );
}
```

---

## URLåŒæœŸã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

### ã‚¹ãƒ†ãƒƒãƒ— 6: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `components/filters/Pagination.tsx`

```typescript
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { cn } from '@/lib/utils';

interface PaginationProps {
  total: number;
  limit: number;
  currentOffset: number;
}

export function Pagination({ total, limit, currentOffset }: PaginationProps) {
  const router = useRouter();
  const searchParams = useSearchParams();

  const totalPages = Math.ceil(total / limit);
  const currentPage = Math.floor(currentOffset / limit) + 1;

  const handlePageChange = (page: number) => {
    const newOffset = (page - 1) * limit;
    const params = new URLSearchParams(searchParams.toString());
    params.set('offset', newOffset.toString());
    router.push(`/library?${params.toString()}`);
  };

  if (totalPages <= 1) return null;

  // ãƒšãƒ¼ã‚¸ç•ªå·ã®é…åˆ—ã‚’ç”Ÿæˆï¼ˆæœ€å¤§7ãƒšãƒ¼ã‚¸åˆ†è¡¨ç¤ºï¼‰
  const getPageNumbers = () => {
    const pages: (number | string)[] = [];

    if (totalPages <= 7) {
      // å…¨ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
      for (let i = 1; i <= totalPages; i++) {
        pages.push(i);
      }
    } else {
      // çœç•¥å½¢ã§è¡¨ç¤º
      if (currentPage <= 3) {
        pages.push(1, 2, 3, 4, '...', totalPages);
      } else if (currentPage >= totalPages - 2) {
        pages.push(1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages);
      } else {
        pages.push(1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages);
      }
    }

    return pages;
  };

  return (
    <div className="flex items-center justify-center gap-2">
      {/* å‰ã¸ */}
      <button
        onClick={() => handlePageChange(currentPage - 1)}
        disabled={currentPage === 1}
        className={cn(
          'flex items-center gap-1 rounded-lg px-3 py-2 text-sm font-medium transition-colors',
          currentPage === 1
            ? 'cursor-not-allowed text-gray-400'
            : 'text-gray-700 hover:bg-gray-100'
        )}
      >
        <ChevronLeft className="h-4 w-4" />
        å‰ã¸
      </button>

      {/* ãƒšãƒ¼ã‚¸ç•ªå· */}
      <div className="flex items-center gap-1">
        {getPageNumbers().map((page, index) => {
          if (page === '...') {
            return (
              <span key={`ellipsis-${index}`} className="px-2 text-gray-500">
                ...
              </span>
            );
          }

          return (
            <button
              key={page}
              onClick={() => handlePageChange(page as number)}
              className={cn(
                'h-9 w-9 rounded-lg text-sm font-medium transition-colors',
                currentPage === page
                  ? 'bg-primary-600 text-white'
                  : 'text-gray-700 hover:bg-gray-100'
              )}
            >
              {page}
            </button>
          );
        })}
      </div>

      {/* æ¬¡ã¸ */}
      <button
        onClick={() => handlePageChange(currentPage + 1)}
        disabled={currentPage === totalPages}
        className={cn(
          'flex items-center gap-1 rounded-lg px-3 py-2 text-sm font-medium transition-colors',
          currentPage === totalPages
            ? 'cursor-not-allowed text-gray-400'
            : 'text-gray-700 hover:bg-gray-100'
        )}
      >
        æ¬¡ã¸
        <ChevronRight className="h-4 w-4" />
      </button>
    </div>
  );
}
```

---

## ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ç®¡ç†

### ã‚¹ãƒ†ãƒƒãƒ— 7: éŸ³æ¥½ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒšãƒ¼ã‚¸ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `app/library/page.tsx`ï¼ˆæ›´æ–°ç‰ˆï¼‰

```typescript
import { Suspense } from 'react';
import { getMusicList, getCategories, getTags } from '@/lib/db/queries';
import { MusicGrid } from '@/components/music/MusicGrid';
import { CategoryFilter } from '@/components/filters/CategoryFilter';
import { TagFilter } from '@/components/filters/TagFilter';
import { SearchBar } from '@/components/filters/SearchBar';
import { SortSelector } from '@/components/filters/SortSelector';
import { Pagination } from '@/components/filters/Pagination';
import { Loader2 } from 'lucide-react';

export const metadata = {
  title: 'éŸ³æ¥½ãƒ©ã‚¤ãƒ–ãƒ©ãƒª - Kaleido AI Music',
  description: 'AIç”ŸæˆéŸ³æ¥½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚æ§˜ã€…ãªã‚¸ãƒ£ãƒ³ãƒ«ã€ãƒ ãƒ¼ãƒ‰ã®éŸ³æ¥½ã‚’è¦–è´ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚',
};

interface LibraryPageProps {
  searchParams: {
    category?: string;
    tags?: string;
    search?: string;
    sortBy?: 'latest' | 'popular' | 'downloads';
    offset?: string;
    limit?: string;
  };
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã®ã‚¹ã‚±ãƒ«ãƒˆãƒ³
function MusicGridSkeleton() {
  return (
    <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      {[...Array(8)].map((_, i) => (
        <div key={i} className="animate-pulse">
          <div className="aspect-square bg-gray-200 rounded-lg" />
          <div className="mt-4 space-y-2">
            <div className="h-4 bg-gray-200 rounded w-3/4" />
            <div className="h-3 bg-gray-200 rounded w-1/2" />
          </div>
        </div>
      ))}
    </div>
  );
}

export default async function LibraryPage({ searchParams }: LibraryPageProps) {
  const category = searchParams.category;
  const tagsParam = searchParams.tags;
  const tags = tagsParam ? tagsParam.split(',') : undefined;
  const search = searchParams.search;
  const sortBy = searchParams.sortBy || 'latest';
  const limit = parseInt(searchParams.limit || '20', 10);
  const offset = parseInt(searchParams.offset || '0', 10);

  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  const [musicList, categoriesList, tagsList] = await Promise.all([
    getMusicList({ category, tags, search, sortBy, limit, offset }),
    getCategories(),
    getTags(50),
  ]);

  return (
    <div className="min-h-screen bg-gray-50 py-12">
      <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900 font-display">éŸ³æ¥½ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h1>
          <p className="mt-2 text-gray-600">AIç”ŸæˆéŸ³æ¥½ã‚’è¦–è´ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</p>
        </div>

        {/* æ¤œç´¢ãƒãƒ¼ã¨ã‚½ãƒ¼ãƒˆ */}
        <div className="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex-1 max-w-md">
            <SearchBar />
          </div>
          <SortSelector />
        </div>

        {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
        <div className="mb-8 space-y-6 rounded-lg bg-white p-6 shadow-sm">
          <CategoryFilter categories={categoriesList} currentCategory={category} />
          <TagFilter tags={tagsList} selectedTags={tags || []} />
        </div>

        {/* éŸ³æ¥½ã‚°ãƒªãƒƒãƒ‰ */}
        <Suspense
          fallback={
            <div className="flex justify-center py-12">
              <Loader2 className="h-8 w-8 animate-spin text-primary-600" />
            </div>
          }
        >
          <MusicGrid musicList={musicList} />
        </Suspense>

        {/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */}
        {musicList.length > 0 && (
          <div className="mt-12">
            <Pagination total={1000} limit={limit} currentOffset={offset} />
          </div>
        )}

        {/* çµæœãŒ0ä»¶ã®å ´åˆ */}
        {musicList.length === 0 && (
          <div className="text-center py-12">
            <p className="text-gray-500">
              {search || category || tags
                ? 'æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹éŸ³æ¥½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'
                : 'éŸ³æ¥½ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
```

### ã‚¹ãƒ†ãƒƒãƒ— 8: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `components/filters/ActiveFilters.tsx`

```typescript
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { X } from 'lucide-react';

export function ActiveFilters() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const category = searchParams.get('category');
  const tagsParam = searchParams.get('tags');
  const tags = tagsParam ? tagsParam.split(',') : [];
  const search = searchParams.get('search');

  const hasFilters = category || tags.length > 0 || search;

  const handleRemoveFilter = (filterType: 'category' | 'tags' | 'search', value?: string) => {
    const params = new URLSearchParams(searchParams.toString());

    if (filterType === 'category') {
      params.delete('category');
    } else if (filterType === 'tags' && value) {
      const currentTags = params.get('tags')?.split(',').filter(Boolean) || [];
      const newTags = currentTags.filter((t) => t !== value);
      if (newTags.length > 0) {
        params.set('tags', newTags.join(','));
      } else {
        params.delete('tags');
      }
    } else if (filterType === 'search') {
      params.delete('search');
    }

    params.delete('offset');
    router.push(`/library?${params.toString()}`);
  };

  const handleClearAll = () => {
    const params = new URLSearchParams(searchParams.toString());
    params.delete('category');
    params.delete('tags');
    params.delete('search');
    params.delete('offset');
    router.push(`/library?${params.toString()}`);
  };

  if (!hasFilters) return null;

  return (
    <div className="flex flex-wrap items-center gap-2">
      <span className="text-sm font-medium text-gray-700">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</span>

      {/* ã‚«ãƒ†ã‚´ãƒª */}
      {category && (
        <button
          onClick={() => handleRemoveFilter('category')}
          className="inline-flex items-center gap-1 rounded-full bg-primary-100 px-3 py-1 text-sm font-medium text-primary-800 hover:bg-primary-200"
        >
          ã‚«ãƒ†ã‚´ãƒª: {category}
          <X className="h-3 w-3" />
        </button>
      )}

      {/* ã‚¿ã‚° */}
      {tags.map((tag) => (
        <button
          key={tag}
          onClick={() => handleRemoveFilter('tags', tag)}
          className="inline-flex items-center gap-1 rounded-full bg-accent-light/20 px-3 py-1 text-sm font-medium text-accent-dark hover:bg-accent-light/30"
        >
          #{tag}
          <X className="h-3 w-3" />
        </button>
      ))}

      {/* æ¤œç´¢ */}
      {search && (
        <button
          onClick={() => handleRemoveFilter('search')}
          className="inline-flex items-center gap-1 rounded-full bg-gray-200 px-3 py-1 text-sm font-medium text-gray-800 hover:bg-gray-300"
        >
          æ¤œç´¢: &quot;{search}&quot;
          <X className="h-3 w-3" />
        </button>
      )}

      {/* ã™ã¹ã¦ã‚¯ãƒªã‚¢ */}
      <button
        onClick={handleClearAll}
        className="text-sm text-gray-600 hover:text-gray-900 underline"
      >
        ã™ã¹ã¦ã‚¯ãƒªã‚¢
      </button>
    </div>
  );
}
```

---

## å‹•ä½œç¢ºèª

### ã‚¹ãƒ†ãƒƒãƒ— 9: ãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆé …ç›®:**

1. **ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**
   - ã‚«ãƒ†ã‚´ãƒªã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦çµã‚Šè¾¼ã¿ãŒå‹•ä½œã™ã‚‹
   - URLã«`?category=pop`ãŒåæ˜ ã•ã‚Œã‚‹
   - ã€Œã™ã¹ã¦ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒè§£é™¤ã•ã‚Œã‚‹

2. **ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**
   - ã‚¿ã‚°ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦çµã‚Šè¾¼ã¿ãŒå‹•ä½œã™ã‚‹
   - è¤‡æ•°ã‚¿ã‚°ã‚’é¸æŠã§ãã‚‹
   - URLã«`?tags=tag1,tag2`ãŒåæ˜ ã•ã‚Œã‚‹
   - ã€Œã‚¯ãƒªã‚¢ã€ã§å…¨ã‚¿ã‚°ãŒè§£é™¤ã•ã‚Œã‚‹

3. **æ¤œç´¢æ©Ÿèƒ½**
   - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã§æ¤œç´¢ãŒå‹•ä½œã™ã‚‹
   - ãƒ‡ãƒã‚¦ãƒ³ã‚¹ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ï¼ˆ500mså¾Œã«æ¤œç´¢ï¼‰
   - URLã«`?search=keyword`ãŒåæ˜ ã•ã‚Œã‚‹
   - Xãƒœã‚¿ãƒ³ã§æ¤œç´¢ã‚¯ãƒªã‚¢ãŒå‹•ä½œã™ã‚‹

4. **ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½**
   - æ–°ç€é †ã€äººæ°—é †ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°é †ã§ä¸¦ã³æ›¿ãˆãŒå‹•ä½œã™ã‚‹
   - URLã«`?sortBy=popular`ãŒåæ˜ ã•ã‚Œã‚‹

5. **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**
   - ãƒšãƒ¼ã‚¸ç§»å‹•ãŒå‹•ä½œã™ã‚‹
   - URLã«`?offset=20`ãŒåæ˜ ã•ã‚Œã‚‹
   - ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨æ™‚ã«ãƒšãƒ¼ã‚¸ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹

6. **è¤‡åˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**
   - ã‚«ãƒ†ã‚´ãƒª + ã‚¿ã‚° + æ¤œç´¢ã®çµ„ã¿åˆã‚ã›ãŒå‹•ä½œã™ã‚‹
   - URLã«å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒåæ˜ ã•ã‚Œã‚‹
   - ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ãƒœã‚¿ãƒ³ã§çŠ¶æ…‹ãŒå¾©å…ƒã•ã‚Œã‚‹

---

## æˆæœç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- [ ] `components/filters/CategoryFilter.tsx` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] `components/filters/TagFilter.tsx` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] `components/filters/SearchBar.tsx` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] `components/filters/SortSelector.tsx` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] `components/filters/Pagination.tsx` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] `components/filters/ActiveFilters.tsx` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹

### æ©Ÿèƒ½

- [ ] ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå‹•ä½œã™ã‚‹
- [ ] ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå‹•ä½œã™ã‚‹
- [ ] æ¤œç´¢æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹
- [ ] ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã™ã‚‹
- [ ] URLåŒæœŸãŒæ­£ã—ãå‹•ä½œã™ã‚‹

### ãƒ‡ãƒ¼ã‚¿

- [ ] ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ãŒã‚·ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹
- [ ] éŸ³æ¥½ãƒ‡ãƒ¼ã‚¿ã«ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹

### UI/UX

- [ ] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ãŒè¦–è¦šçš„ã«åˆ†ã‹ã‚‹
- [ ] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢ãŒç°¡å˜ã«ã§ãã‚‹
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ãŒå‹•ä½œã™ã‚‹

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 4ãŒå®Œäº†ã—ãŸã‚‰ã€Phase 5ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã€ã«é€²ã¿ã¾ã™ã€‚

**æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `20251023_05-download-feature.md`

Phase 5ã§ã¯ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¾ã™:
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰API
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- å†ç”Ÿå›æ•°ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆç®¡ç†è€…å‘ã‘ï¼‰

---

## ã¾ã¨ã‚

Phase 4ã§ã¯ã€éŸ³æ¥½ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

**é”æˆã—ãŸã“ã¨:**
- âœ… ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
- âœ… ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
- âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
- âœ… ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
- âœ… URLåŒæœŸ
- âœ… ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

**æ‰€è¦æ™‚é–“:** ç´„1-2æ—¥ï¼ˆ8-16æ™‚é–“ï¼‰

æ¬¡ã®Phaseã«é€²ã‚€æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆè€…**: AI Agent (Claude)
**ä½œæˆæ—¥**: 2025å¹´10æœˆ23æ—¥
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
