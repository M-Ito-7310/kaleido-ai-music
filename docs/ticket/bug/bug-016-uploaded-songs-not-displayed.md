# Bug #016: 新規アップロード楽曲がダッシュボード・ライブラリに反映されない

**ステータス**: 🟡 進行中
**優先度**: High
**担当**: AIエージェント
**作成日**: 2025-10-30
**開始日時**: 2025-10-30 00:00
**完了日**: -

## 🐛 バグ概要

新規アップロードされた楽曲がDBには正しく登録されているものの、ダッシュボードとライブラリページに表示されない。音楽管理ページでは正しく表示されているため、特定のページでのデータ取得ロジックに問題がある可能性が高い。

## 📍 発生環境

- ブラウザ: 未確認
- OS: 未確認
- URL: ダッシュボード (`/dashboard`) およびライブラリ (`/library`)
- バージョン: -

## 🔄 再現手順

1. 音楽管理ページから新しい楽曲をアップロードする
2. アップロード完了を確認する
3. ダッシュボードまたはライブラリページに遷移する
4. 新規アップロードした楽曲が表示されていないことを確認

## ❌ 期待される動作

新規アップロードされた楽曲は、即座にダッシュボードとライブラリページに反映され、他の楽曲と同様に表示されるべき。

## 🚨 実際の動作

- 音楽管理ページ: 新規楽曲が正しく表示される（DBには登録されている）
- ダッシュボード: 新規楽曲が表示されない
- ライブラリ: 新規楽曲が表示されない

## 📸 スクリーンショット/ログ

未添付

## 🔍 原因分析

**特定した原因**:

1. **Next.jsのキャッシュ問題**
   - ダッシュボード（トップページ）に `force-dynamic` が設定されていなかった
   - ビルド時のデータがキャッシュされ、新規アップロード後も古いデータが表示されていた
   - ライブラリページには `force-dynamic` が設定されていたが、ダッシュボードには未設定

2. **isPublished フィールドの扱い**
   - スキーマではデフォルト値が `1`（公開）に設定されているが、明示的に設定していなかった
   - 何らかの理由でデフォルト値が適用されない可能性があった

**問題箇所**:
- [app/page.tsx](app/page.tsx): `force-dynamic` 未設定
- [app/api/admin/music/route.ts:109](app/api/admin/music/route.ts#L109): `isPublished` の明示的設定なし

## ✅ 修正内容

**修正1**: ダッシュボードに `force-dynamic` を追加
- ファイル: [app/page.tsx:8](app/page.tsx#L8)
- 変更内容: `export const dynamic = 'force-dynamic';` を追加
- 理由: Next.jsのキャッシュを無効化し、常に最新のデータベースデータを取得

**修正2**: アップロード時に `isPublished` を明示的に `1` に設定
- ファイル: [app/api/admin/music/route.ts:109-112](app/api/admin/music/route.ts#L109-L112)
- 変更内容: `createMusic` 呼び出し時に `isPublished: 1` を明示的に追加
- 理由: アップロード直後に無条件で公開されるようにする

**修正3**: アップロード後に `revalidatePath` でキャッシュを無効化
- ファイル: [app/api/admin/music/route.ts:115-119](app/api/admin/music/route.ts#L115-L119)
- 変更内容: 音楽作成後に `revalidatePath` を呼び出してキャッシュをクリア
- 理由: Next.jsのキャッシュとデータベースクエリキャッシュを強制的にクリアし、件数とタグが即座に反映されるようにする

- [x] 修正コミット: 次のコミットで記録
- [x] 影響範囲: ダッシュボード（トップページ）、新規音楽アップロード処理
- [x] テスト実施: 本番環境でのテスト予定

### 修正詳細

**修正前**:
```typescript
// app/page.tsx
export default async function HomePage() {
  // force-dynamic なし
```

**修正後**:
```typescript
// app/page.tsx
export const dynamic = 'force-dynamic';

export default async function HomePage() {
```

**修正前**:
```typescript
// app/api/admin/music/route.ts
const newMusic = await createMusic(validatedData);
```

**修正後**:
```typescript
// app/api/admin/music/route.ts
const newMusic = await createMusic({
  ...validatedData,
  isPublished: 1, // 無条件で公開
});
```

## 🧪 テスト確認項目

- [ ] 新規アップロード後、ダッシュボードに楽曲が表示されることを確認
- [ ] 新規アップロード後、ライブラリに楽曲が表示されることを確認
- [ ] 音楽管理ページでも引き続き正しく表示されることを確認
- [ ] 既存の楽曲が正しく表示されることを確認（デグレードチェック）
- [ ] ページリロード後も新規楽曲が表示されることを確認
- [ ] 複数の楽曲を連続アップロードした場合の動作確認

## 📝 メモ

チケット作成日: 2025-10-30
修正実施日: 2025-10-30

**修正のポイント**:
- Next.jsのSSRキャッシュが原因でデータが古いまま表示されていた
- `force-dynamic` を追加することで、ページアクセス時に毎回最新データを取得
- `isPublished` を明示的に設定することで、アップロード直後の公開を保証
- `revalidatePath` を追加することで、音楽作成時に全ページのキャッシュを強制クリア
- タグや件数も `revalidatePath` により即座に最新状態で表示される

## 🔗 関連

- 関連Issue: -
- 関連PR: -
- 参考資料: -
