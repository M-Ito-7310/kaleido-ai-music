# Bug #008: ダウンロード時のファイル名が正しく設定されない

**ステータス**: 🟢 完了
**優先度**: Medium
**担当**: AIエージェント
**作成日**: 2025-10-27
**開始日時**: 2025-10-27 21:30
**完了日時**: 2025-10-27 22:00
**実績時間**: 約30分

## 🐛 バグ概要

音楽ファイルをダウンロードすると、ファイル名が「Unknown Artist - __________.mp3」という名称になってしまう。本来は曲のタイトルを使用したファイル名（例: 「未来のページに綴る光.mp3」）でダウンロードされるべき。

## 📍 発生環境

- ブラウザ: 未確認
- OS: 未確認
- URL: ライブラリページまたは音楽プレーヤーのダウンロード機能
- バージョン: -

## 🔄 再現手順

1. ライブラリページで音楽を表示
2. ダウンロードボタンをクリック
3. ダウンロードされたファイルの名前を確認

## ❌ 期待される動作

ダウンロードされるファイル名は、音楽のタイトルを使用した名称になるべき。

例: 「未来のページに綴る光.mp3」

## 🚨 実際の動作

ダウンロードされるファイル名が「Unknown Artist - __________.mp3」という不適切な名称になっている。

## 📸 スクリーンショット/ログ

未添付

## 🔍 原因分析

**実施完了**: 2025-10-27 21:35

### 問題箇所
- ファイル: `components/music/DownloadButton.tsx:31`
- 問題のコード:
```typescript
const filename = `${artist} - ${title}.mp3`.replace(/[^a-zA-Z0-9\s\-_.]/g, '_');
```

### 原因
ファイル名生成時に日本語を含む特殊文字をすべて `_` に置換していたため、日本語のタイトルが消えてしまっていた。

具体的には：
1. 現在の正規表現 `/[^a-zA-Z0-9\s\-_.]/g` は「英数字、スペース、ハイフン、アンダースコア、ピリオド以外」をすべて `_` に置換
2. 日本語文字（ひらがな、カタカナ、漢字）は英数字ではないため、すべて `_` に変換される
3. 結果として「未来のページに綴る光」→ 「________」のようになっていた

## ✅ 修正内容

**実施完了**: 2025-10-27 21:35

- [x] 修正コミット: （次のコミットで記録）
- [x] 影響範囲: `components/music/DownloadButton.tsx` のみ
- [x] テスト実施: 本番環境で動作確認予定

### 修正詳細
- ファイル: `components/music/DownloadButton.tsx`
- 変更内容: ファイル名のサニタイズロジックを日本語対応に変更
- 修正前:
```typescript
const filename = `${artist} - ${title}.mp3`.replace(/[^a-zA-Z0-9\s\-_.]/g, '_');
```
- 修正後:
```typescript
const filename = `${title}.mp3`
  .replace(/[<>:"/\\|?*]/g, '') // ファイルシステムで禁止されている文字を除去
  .replace(/\s+/g, ' ')          // 複数の空白を1つに
  .trim();                       // 前後の空白を削除
```
- 理由: 日本語を含む多言語のタイトルをサポートするため、ファイルシステムで問題となる文字のみを除去するように変更
- 追加修正: アーティスト名を除外し、タイトルのみのファイル名に変更（ユーザー要望）

## 🧪 テスト確認項目

- [x] 音楽ファイルのダウンロード時にタイトルが正しくファイル名に設定される
- [x] 特殊文字を含むタイトルが適切にサニタイズされる
- [x] タイトルのみのファイル名形式になる（アーティスト名は除外）
- [x] 日本語タイトルが正しく表示される
- [x] 本番環境で動作確認済み

## 📝 メモ

チケット作成日: 2025-10-27
修正実施日: 2025-10-27 21:35
修正者: AIエージェント

ダウンロード機能のファイル名生成ロジックを日本語対応に修正。
ファイルシステムで問題となる文字（`< > : " / \ | ? *`）のみを除去し、日本語文字はそのまま保持するように変更。

### 完了記録
完了日時: 2025-10-27 22:00
実績時間: 約30分
Git commit: a55ba8e, 22c1436

#### 最終確認
- [x] バグが完全に修正されている
- [x] 関連機能に影響がない
- [x] 本番環境で動作確認済み
- [x] 日本語ファイル名が正しく表示される

## 🔗 関連

- 関連Issue: -
- 関連PR: -
- 参考資料: -
