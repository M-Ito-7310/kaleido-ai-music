# Bug #015: 音楽プレイヤーのシークバー移動が動作しない

**ステータス**: ✅ 完了
**優先度**: High
**担当**: AIエージェント
**作成日**: 2025-10-29
**開始日時**: 2025-10-29 00:15
**完了日**: 2025-10-29

## 🐛 バグ概要

音楽プレイヤー（ミニプレイヤー）においてシークバーの移動操作ができない。
詳細ページのシークバーは正常に動作しているが、ミニプレイヤーのシークバーのみ動作しない。

## 📍 発生環境

- ブラウザ: 未確認
- OS: 未確認
- URL: ミニプレイヤー（GlobalPlayer）
- バージョン: -

## 🔄 再現手順

1. 音楽を再生する
2. ミニプレイヤーのシークバーをクリックまたはドラッグして移動を試みる
3. シークバーが移動しない

## ❌ 期待される動作

ミニプレイヤーのシークバーをクリック/ドラッグすることで、再生位置を自由に変更できるべき。

## 🚨 実際の動作

ミニプレイヤーのシークバーをクリック/ドラッグしても、再生位置が変更されない。
詳細ページのシークバーは正常に動作している。

## 📸 スクリーンショット/ログ

未添付

## 🔍 原因分析

### ミニプレイヤー（MiniPlayer.tsx）
1. Framer Motionの`drag="x"`がシークバーの入力イベントを干渉していた
2. seekTo関数がPlayerContextを経由してAudioPlayerに接続されていなかった

### フルスクリーンプレイヤー（SeekBar.tsx）
1. `useCallback`を使用すべき箇所で`useEffect`が必要だった（イベントリスナー登録）
2. Framer Motionの`whileHover/whileTap`とCSS transformが競合していた
3. ドラッグ中に`seekTo`を都度呼び出していたため、ミニプレイヤーと動作が異なっていた

## ✅ 修正内容

### Phase 1: ミニプレイヤーの修正
- [x] シークバーを独立したレイヤーに分離（Framer Motionのドラッグコンテナの外）
- [x] PlayerContextに`registerSeekHandler`メカニズムを追加
- [x] GlobalPlayerで`AudioPlayer.seek()`を呼び出すhandlerを登録
- [x] `isSeekingRef`フラグを追加し、シーク中の`timeupdate`イベントを無視

### Phase 2: フルスクリーンプレイヤーの修正
- [x] SeekBarコンポーネントの`useCallback`を`useEffect`に修正（イベントリスナー管理）
- [x] つまみ位置の計算をFramer Motionの`x`, `y`プロパティに変更
- [x] ドラッグ中は視覚的な更新のみ行い、ドロップ後にシークを実行するように変更
- [x] 時刻表示もドラッグ中は`dragProgress`を使用

### 修正コミット
- `1ec49f2` - fix(player): seekbar drag not working in fullscreen player
- `f903b45` - fix(player): シークバーのつまみ位置表示を修正
- `3184281` - fix(player): シークバーつまみ位置のずれを修正
- `7181835` - fix(player): Framer Motion変換プロパティを使用してつまみ位置を修正
- `9cf7c09` - feat(player): フルスクリーンプレイヤーのシークをドラッグ終了時に実行
- `746841a` - debug(player): シークバードラッグ時の動作をデバッグ
- `243f302` - chore(player): デバッグログを削除

### 影響範囲
- components/music/MiniPlayer.tsx
- components/music/GlobalPlayer.tsx
- components/music/SeekBar.tsx
- lib/contexts/PlayerContext.tsx

### テスト実施
- [x] 本番環境でミニプレイヤーのシークバードラッグ動作確認
- [x] 本番環境でフルスクリーンプレイヤーのシークバードラッグ動作確認
- [x] ドラッグ終了時にシークが実行されることを確認
- [x] つまみの表示位置が正確であることを確認

## 🧪 テスト確認項目

- [x] バグが修正されていることを確認
- [x] 関連機能に影響がないことを確認
- [x] ミニプレイヤーとフルスクリーンプレイヤーの動作が統一されている
- [x] ドラッグ中は曲の再生位置が変わらず、ドロップ後に変わる

## 📝 メモ

チケット作成日: 2025-10-29

詳細ページのシークバーは正常動作していることから、ミニプレイヤー固有の実装に問題がある可能性が高い。
GlobalPlayerコンポーネントとMusicPlayerコンポーネントの実装差異を確認する必要がある。

## 🔗 関連

- 関連Issue: -
- 関連PR: -
- 参考資料: -
