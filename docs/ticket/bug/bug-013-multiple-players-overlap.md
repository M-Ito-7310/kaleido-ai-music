# Bug #013: ミニプレイヤーと詳細ページのプレイヤーで音楽が重なる問題

**ステータス**: 🟡 進行中
**優先度**: High
**担当**: AIエージェント
**作成日**: 2025-10-28
**開始日時**: 2025-10-28 17:30
**完了日**: -

## 🐛 バグ概要

ミニプレイヤーで音楽を再生中に、詳細ページのプレイヤーで別の楽曲（または同じ楽曲）を再生すると、2つの音源が同時に再生されて音楽が重なってしまう。ミニプレイヤーと詳細ページのプレイヤーが独立して動作しており、連動していないことが原因と考えられる。

## 📍 発生環境

- ブラウザ: 未確認
- OS: 未確認
- URL: 詳細ページ（楽曲詳細画面）
- バージョン: -

## 🔄 再現手順

1. ミニプレイヤーで任意の楽曲を再生する
2. 楽曲詳細ページに遷移する
3. 詳細ページのプレイヤーで再生ボタンをクリックする
4. 2つの音楽が同時に再生される

## ❌ 期待される動作

詳細ページのプレイヤーで再生を開始した際、ミニプレイヤーの再生が自動的に停止され、1つの音源のみが再生される。または、ミニプレイヤーと詳細ページのプレイヤーが同期して、同じ再生状態を共有する。

## 🚨 実際の動作

ミニプレイヤーと詳細ページのプレイヤーが独立して動作し、両方のプレイヤーから音楽が同時に再生される。

## 📸 スクリーンショット/ログ

未添付

## 🔍 原因分析

ミニプレイヤー（GlobalPlayer.tsx）と詳細ページのプレイヤー（MusicPlayer.tsx）がそれぞれ独立したAudioPlayerインスタンスを作成していたため、再生状態が共有されず、両方のプレイヤーから同時に音楽が再生される問題が発生していた。

- **GlobalPlayer.tsx**: PlayerContextを使用してアプリ全体の再生状態を管理し、独自のAudioPlayerインスタンスを保持
- **MusicPlayer.tsx**: PlayerContextを使用せず、独自のAudioPlayerインスタンスを保持し、完全に独立して動作

## ✅ 修正内容

詳細ページのMusicPlayer.tsxをPlayerContextと統合し、グローバルプレイヤーと同じ再生状態を共有するように修正。

- [x] 修正コミット: 実施済み
- [x] 影響範囲: MusicPlayer.tsx, app/music/[id]/page.tsx
- [x] テスト実施: 本番環境で確認予定

### 修正詳細

#### 1. components/music/MusicPlayer.tsx
- **変更内容**:
  - 独自のAudioPlayerインスタンスを削除
  - usePlayer()フックを使用してPlayerContextの状態を取得
  - 再生ボタンクリック時にplayTrack()を呼び出してグローバルプレイヤーに再生を委譲
  - ボリュームコントロールを削除（グローバルプレイヤーに統一）
  - シークバーは現在再生中の楽曲の場合のみ有効化
- **理由**: プレイヤー間で再生状態を共有し、音楽の重複再生を防止するため

#### 2. app/music/[id]/page.tsx
- **変更内容**:
  - MusicPlayerコンポーネントにmusicDataプロパティを追加
- **理由**: PlayerContextに楽曲データを渡すため

## 🧪 テスト確認項目

- [ ] ミニプレイヤー再生中に詳細ページで再生すると、ミニプレイヤーが停止することを確認
- [ ] 詳細ページ再生中にミニプレイヤーで再生すると、詳細ページが停止することを確認
- [ ] 複数のブラウザで動作確認
- [ ] プレイヤー間の状態同期が正常に動作することを確認
- [ ] 音楽の重複再生が発生しないことを確認

## 📝 メモ

チケット作成日: 2025-10-28
修正実施日: 2025-10-28 17:45

### 修正のポイント
- 詳細ページのプレイヤーをPlayerContextと統合することで、アプリ全体で単一のオーディオソースを共有
- ミニプレイヤーと詳細ページのプレイヤーが完全に同期し、音楽の重複再生を防止
- ユーザー体験の向上: どのページからでも一貫した再生体験を提供

## 🔗 関連

- 関連Issue: -
- 関連PR: -
- 参考資料: -
