# Feature #003: AI音楽共有リンクフィールドの追加

**ステータス**: 🟡 進行中
**優先度**: Medium
**担当**: AIエージェント
**作成日**: 2025-10-27
**開始日時**: 2025-10-27 13:30
**完了日**: -

## ✨ 機能概要

AI音楽アップロードフォームに、Suno AIなどのAI音楽生成サービスで発行される共有リンクを任意で設定できるフィールドを追加する。

## 🎯 目的・背景

Suno AIなどのAI音楽生成サービスでは、生成された音楽に対して共有リンクが発行される。このリンクを保存することで、以下のメリットがある:
- オリジナルの生成元へのトレーサビリティ確保
- 楽曲の詳細情報（生成パラメータ、プロンプトなど）へのアクセス
- 共有・引用時の情報源として活用

## 📋 主要機能

1. アップロードフォームに共有リンク入力フィールドを追加（任意項目）
2. 入力されたURLのバリデーション（URL形式チェック）
3. データベースへの保存
4. 楽曲詳細ページでの共有リンク表示

## 🔧 技術仕様

### データ構造
- 既存の楽曲テーブルに `shareLink` カラムを追加（nullable）
- 型: `VARCHAR(500)` または `TEXT`

### API設計
- 既存のアップロードAPIを拡張
- リクエスト: `shareLink` フィールドを追加（オプショナル）
- バリデーション: URL形式のチェック

### UI/UXデザイン
- アップロードフォームに新しいテキストフィールドを追加
- ラベル: "共有リンク（任意）"
- プレースホルダー: "例: https://suno.com/song/..."
- 楽曲詳細ページに共有リンクを表示（設定されている場合）

### 依存関係
- 既存のアップロード機能への影響: フォームフィールドの追加のみ
- 新しいパッケージ: なし（既存のバリデーションライブラリを使用）

## ✅ 実装タスク

### バックエンド
- [x] データベーススキーマに `shareLink` カラムを追加
- [x] アップロードAPI Routesに `shareLink` フィールドを追加
- [x] URLバリデーション実装
- [x] エラーハンドリング

### フロントエンド
- [x] アップロードフォームコンポーネントに共有リンクフィールドを追加
- [x] フォームバリデーション（URL形式チェック）
- [x] 楽曲詳細ページに共有リンク表示機能を追加
- [x] UIデザイン（レスポンシブ対応）

### テスト
- [ ] 単体テスト（バリデーション）
- [ ] 統合テスト（API連携）
- [ ] E2Eテスト（アップロードフロー）

## 📦 成果物

- [x] データベースマイグレーションファイル
- [x] 更新されたアップロードAPIエンドポイント
- [x] 更新されたアップロードフォームコンポーネント
- [x] 更新された楽曲詳細ページコンポーネント

## 🎯 完了条件

- [ ] すべての実装タスクが完了
- [ ] テストが全てパス
- [ ] ドキュメントが更新されている
- [ ] コードレビュー完了
- [ ] 本番環境で動作確認

## 🧪 テスト計画

### 単体テスト
- [ ] URL形式のバリデーションが正しく動作する
- [ ] 空の値（null/undefined）が許可される
- [ ] 不正なURL形式が拒否される

### 統合テスト
- [ ] 共有リンク付きでアップロードできる
- [ ] 共有リンクなしでアップロードできる
- [ ] 保存された共有リンクが正しく取得できる

### E2Eテスト
- [ ] アップロードフォームから共有リンクを入力して保存できる
- [ ] 楽曲詳細ページで共有リンクが表示される
- [ ] 共有リンクをクリックすると外部サイトに遷移する

### ブラウザテスト
- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Mobile Safari (iOS)
- [ ] Chrome Mobile (Android)

## 📝 メモ

チケット作成日: 2025-10-27

- 共有リンクは任意項目とし、入力を強制しない
- 将来的には対応サービス（Suno AI, Udio, etc.）のアイコン表示なども検討可能
- セキュリティ: XSS対策のため、リンク表示時は適切にエスケープする

### 実装詳細
実装日: 2025-10-27 13:30
実装者: AIエージェント

#### 作成したファイル
- drizzle/0001_silly_gunslinger.sql - データベースマイグレーションファイル

#### 修正したファイル
- lib/db/schema.ts - musicテーブルに`shareLink: text('share_link')`カラムを追加
- app/api/admin/music/route.ts - createMusicSchemaに`shareLink: z.string().url().optional().or(z.literal(''))`を追加
- components/admin/AdminMusicUploadForm.tsx - フォームステートとUIに共有リンクフィールドを追加
- app/music/[id]/page.tsx - 楽曲詳細ページに共有リンク表示セクションを追加（ExternalLinkアイコン使用）

#### 技術的な決定事項
- データベース型: `text`型を使用（長いURLにも対応可能）
- バリデーション: Zodで`z.string().url().optional().or(z.literal(''))`として、空文字列も許容
- UI配置: アップロードフォームでは「ムード」フィールドと並列に配置
- 表示位置: 楽曲詳細ページでは説明文の後、プレイヤーの前に配置
- アイコン: ExternalLinkアイコンを使用し、外部リンクであることを明示
- セキュリティ: `target="_blank"` と `rel="noopener noreferrer"` を設定

#### 注意点
- データベースマイグレーションは本番環境へのpush時に自動適用される
- 既存の楽曲データには`shareLink`がnullとして保存される

## 🔗 関連

- 関連Issue: -
- 関連PR: -
- 参考資料: -
- デザインモックアップ: -
