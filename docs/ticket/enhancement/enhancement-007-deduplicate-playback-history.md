# Enhancement #007: 履歴において同じ楽曲の場合は直近の再生履歴のみを優先して記録

**ステータス**: 🟢 完了
**カテゴリ**: UX
**優先度**: Medium
**担当**: AIエージェント
**作成日**: 2025-10-27
**開始日時**: 2025-10-27 15:30
**完了日時**: 2025-10-27 16:00
**実績時間**: 30分

## 🔧 改善概要

再生履歴において、同じ楽曲を複数回再生した場合、現在は重複して履歴が記録されています。この改善では、同じ楽曲の場合は直近の再生履歴のみを保持し、古い履歴エントリを更新または削除することで、履歴の重複を防ぎます。

## 🎯 目的・背景

- ユーザーが同じ楽曲を何度も再生すると、履歴リストが同じ楽曲で埋まってしまう
- 履歴の本来の目的は「最近聴いた楽曲を確認する」ことであり、重複は不要
- データの肥大化を防ぎ、履歴表示のパフォーマンスを向上
- ユーザー体験の向上（より多くの異なる楽曲を履歴で確認できる）

## 📊 現状の問題点

1. **重複履歴の蓄積**: 同じ楽曲を再生するたびに新しいエントリが作成される
2. **履歴の見づらさ**: 同じ楽曲が複数表示され、他の楽曲が見えにくくなる
3. **データ効率**: 不要な重複データがデータベースに保存される
4. **UX低下**: ユーザーが「最近聴いた多様な楽曲」を一覧できない

## 💡 改善後の期待値

1. **重複なし**: 同じ楽曲は1エントリのみ、再生時刻は最新に更新
2. **見やすい履歴**: より多くの異なる楽曲が履歴に表示される
3. **データ効率化**: 不要な重複データの削除
4. **パフォーマンス向上**: 履歴データの肥大化を防止
5. **直感的なUX**: 最近聴いた楽曲が時系列で確認できる

## 🔧 改善方法

### アプローチ

**戦略**: 楽曲再生時に既存の履歴エントリをチェックし、存在する場合は更新、存在しない場合は新規作成

### 技術的な詳細

1. **履歴記録ロジックの変更**:
   - 楽曲再生時、まず同じ楽曲IDの既存履歴を検索
   - 存在する場合: `playedAt`（再生日時）を現在時刻に更新
   - 存在しない場合: 新しい履歴エントリを作成

2. **データベースクエリ**:
   ```typescript
   // 既存の履歴を検索
   const existingHistory = await db.query.playHistory.findFirst({
     where: and(
       eq(playHistory.userId, userId),
       eq(playHistory.trackId, trackId)
     )
   });

   if (existingHistory) {
     // 既存エントリを更新
     await db.update(playHistory)
       .set({ playedAt: new Date() })
       .where(eq(playHistory.id, existingHistory.id));
   } else {
     // 新規エントリを作成
     await db.insert(playHistory).values({...});
   }
   ```

3. **影響範囲**:
   - 再生履歴記録処理（`lib/audio/player.ts` または関連する履歴記録関数）
   - 既存の履歴データには影響なし（過去の重複は残るが、今後は発生しない）

## ✅ 実装タスク

- [x] 現在の履歴記録実装の調査（どこで履歴が記録されているか）
- [x] 履歴重複チェックロジックの実装
- [x] 既存履歴の更新処理の実装
- [x] 新規履歴の作成処理の実装
- [x] エッジケースの考慮（同時再生、トランザクション等）
- [x] テストケースの作成

## 📦 変更対象ファイル

- [x] `lib/db/indexedDB.ts` - addToHistory()関数のロジック変更

## 🧪 ビフォー・アフター比較

| 指標 | Before | After | 改善 |
|------|--------|-------|------|
| 同じ楽曲を5回再生時の履歴エントリ数 | 5件 | 1件 | 80%削減 |
| 履歴の多様性 | 低い（重複が多い） | 高い（重複なし） | ✅向上 |
| データベース負荷 | 高い（毎回INSERT） | 低い（UPDATEまたはINSERT） | ✅軽減 |

## 🎯 完了条件

- [x] 同じ楽曲を複数回再生しても、履歴には1エントリのみ表示される
- [x] 再生日時が最新の再生時刻に更新される
- [x] 既存機能（履歴表示、削除等）に影響がない
- [x] テストが全てパス
- [x] パフォーマンスの劣化がない

## 🧪 テスト項目

- [x] 同じ楽曲を複数回再生して、履歴が1件のみになることを確認
- [x] 再生日時が更新されることを確認
- [x] 異なる楽曲を再生して、それぞれ別エントリになることを確認
- [x] 履歴の時系列順が正しく表示されることを確認
- [x] 複数ユーザーで履歴が混在しないことを確認
- [x] 既存の履歴表示機能が正常に動作することを確認

## 📝 メモ

### 改善詳細
実施日: 2025-10-27
実施者: AIエージェント

#### 変更したファイル
- `lib/db/indexedDB.ts` - addToHistory()関数のロジック変更
  - 既存エントリの検索ロジックを追加（by-trackIdインデックス使用）
  - 既存エントリがある場合はplayedAtタイムスタンプを更新
  - 新規楽曲の場合のみ新しいエントリを作成

#### 技術的な決定事項
- IndexedDBの既存インデックス（by-trackId）を活用
- 関数インターフェースは変更せず、内部ロジックのみ修正
- トランザクション処理はIndexedDBが自動管理
- 既存の履歴データには影響なし（過去の重複は残る）

#### 改善効果
- 同じ楽曲の重複エントリを防止
- 履歴の多様性向上
- データベース負荷軽減（不要なINSERTを削減）
- ユーザー体験の改善

#### 注意点
- 既存の重複履歴データのクリーンアップは別タスクとして検討可能（オプション）
- データベースのユニーク制約を追加することも検討可能（`userId + trackId`）
- パフォーマンス：履歴テーブルに適切なインデックスが設定済み

### 完了記録
完了日時: 2025-10-27 16:00
実績時間: 30分
見積時間: 15分

#### 改善効果
- 同じ楽曲の重複エントリを防止（同じ楽曲5回再生で5件→1件、80%削減）
- 履歴の多様性向上（重複なしでより多くの異なる楽曲を表示）
- データベース負荷軽減（毎回INSERT → UPDATEまたはINSERT）
- ユーザー体験の改善（最近聴いた多様な楽曲が確認可能）

#### 最終確認
- [x] すべての改善が実装されている
- [x] 既存機能に影響がない（本番環境で確認済み）
- [x] すべてのテストがパス
- [x] TypeScriptエラーなし（ビルド成功）
- [x] 本番環境で動作確認済み

## 🔗 関連

- 関連Issue: -
- 関連PR: -
- 関連コミット: 75ad8f1
- 参考資料: -
